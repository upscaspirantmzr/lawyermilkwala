<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>User Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js"></script>
</head>
<body class="bg-light">
  <nav class="navbar navbar-dark bg-primary">
    <div class="container-fluid">
      <span class="navbar-brand">Milk Delivery - User Dashboard</span>
      <button id="logoutBtn" class="btn btn-danger btn-sm">Logout</button>
    </div>
  </nav>

  <div class="container py-4">
    <h3>Welcome, <span id="userName">Loading...</span></h3>

    <div class="row mt-4">
      <!-- Profile Section -->
      <div class="col-md-4">
        <div class="card shadow-sm">
          <div class="card-body">
            <h5 class="card-title">Profile</h5>
            <p><strong>Email:</strong> <span id="userEmail">Loading...</span></p>
            <p><strong>Phone:</strong> <span id="userPhone">Loading...</span></p>
          </div>
        </div>
      </div>

      <!-- Subscription Section -->
      <div class="col-md-4">
        <div class="card shadow-sm">
          <div class="card-body">
            <h5 class="card-title">Subscription</h5>
            <p id="userSubscription">Loading...</p>
          </div>
        </div>
      </div>

      <!-- Orders Section -->
      <div class="col-md-4">
        <div class="card shadow-sm">
          <div class="card-body">
            <h5 class="card-title">My Orders</h5>
            <ul id="userOrders" class="list-group small">
              <li class="list-group-item">Loading...</li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>

<script type="module">
  // ðŸ”¹ Import Firebase config
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
  import { getFirestore, doc, getDoc, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

  import { firebaseConfig } from "./firebaseConfig.js"; // âœ… Make sure this file exists
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const userName = document.getElementById("userName");
  const userEmail = document.getElementById("userEmail");
  const userPhone = document.getElementById("userPhone");
  const userSubscription = document.getElementById("userSubscription");
  const userOrders = document.getElementById("userOrders");

  // ðŸŸ¢ Check user login
  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      window.location.href = "userLogin.html";
      return;
    }

    // ðŸ”¹ Load profile
    const userDoc = await getDoc(doc(db, "users", user.uid));
    if (userDoc.exists()) {
      let data = userDoc.data();
      userName.textContent = data.name || "User";
      userEmail.textContent = data.email || user.email;
      userPhone.textContent = data.phone || "Not set";
    } else {
      userName.textContent = "New User";
    }

    // ðŸ”¹ Load subscription
    const subQuery = query(collection(db, "subscriptions"), where("userId", "==", user.uid));
    const subSnap = await getDocs(subQuery);
    if (!subSnap.empty) {
      subSnap.forEach(doc => {
        userSubscription.textContent = `${doc.data().plan} - Status: ${doc.data().status}`;
      });
    } else {
      userSubscription.textContent = "No subscription yet";
    }

    // ðŸ”¹ Load orders
    const orderQuery = query(collection(db, "orders"), where("userId", "==", user.uid));
    const orderSnap = await getDocs(orderQuery);
    userOrders.innerHTML = "";
    if (!orderSnap.empty) {
      orderSnap.forEach(doc => {
        let li = document.createElement("li");
        li.className = "list-group-item";
        li.textContent = `Order: ${doc.data().item} - ${doc.data().status}`;
        userOrders.appendChild(li);
      });
    } else {
      userOrders.innerHTML = "<li class='list-group-item'>No orders yet</li>";
    }
  });

  // ðŸ”´ Logout
  document.getElementById("logoutBtn").addEventListener("click", () => {
    signOut(auth).then(() => {
      window.location.href = "userLogin.html";
    });
  });
</script>
</body>
</html>
