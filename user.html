<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Milk Delivery â€“ User Portal</title>
  <!-- TailwindCSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Minimal extras */
    .card { @apply rounded-2xl shadow-lg bg-white; }
    .btn { @apply px-4 py-2 rounded-xl font-medium transition transform active:scale-95; }
    .btn-primary { @apply bg-indigo-600 text-white hover:bg-indigo-700; }
    .btn-outline { @apply border border-gray-300 hover:bg-gray-50; }
    .badge { @apply inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium; }
    .badge-gray { @apply bg-gray-100 text-gray-700; }
    .badge-green { @apply bg-green-100 text-green-700; }
    .badge-yellow { @apply bg-yellow-100 text-yellow-700; }
    .badge-blue { @apply bg-blue-100 text-blue-700; }
    .badge-indigo { @apply bg-indigo-100 text-indigo-700; }
    .fade-in { animation: fadeIn .35s ease-out; }
    @keyframes fadeIn { from {opacity:0; transform: translateY(6px);} to {opacity:1; transform:none;} }
  </style>
</head>
<body class="min-h-screen bg-gray-50 text-gray-900">
  <div class="max-w-6xl mx-auto px-4 py-8">
    <!-- Header -->
    <header class="mb-8">
      <div class="flex items-center justify-between">
        <h1 class="text-2xl md:text-3xl font-bold">ðŸ¥› Milk Delivery â€“ User Portal</h1>
        <nav class="space-x-2">
          <a href="#" id="btnGoAuth" class="btn btn-outline hidden">Auth</a>
          <a href="#" id="btnGoDashboard" class="btn btn-outline hidden">Dashboard</a>
          <button id="btnLogout" class="btn btn-outline hidden">Logout</button>
        </nav>
      </div>
    </header>

    <!-- ===== AUTH SECTION ===== -->
    <section id="authSection" class="fade-in">
      <div class="grid md:grid-cols-2 gap-6">
        <!-- Register Card -->
        <div class="card p-6">
          <h2 class="text-xl font-semibold mb-1">Create your account</h2>
          <p class="text-sm text-gray-600 mb-4">Register as a <b>User</b> to subscribe and track deliveries.</p>
          <form id="registerForm" class="space-y-3">
            <div>
              <label class="block text-sm mb-1">Full Name</label>
              <input type="text" id="regName" class="w-full border rounded-xl px-3 py-2" placeholder="Your name" required />
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
              <div>
                <label class="block text-sm mb-1">Phone</label>
                <input type="tel" id="regPhone" class="w-full border rounded-xl px-3 py-2" placeholder="10-digit phone" required />
              </div>
              <div>
                <label class="block text-sm mb-1">Email</label>
                <input type="email" id="regEmail" class="w-full border rounded-xl px-3 py-2" placeholder="you@example.com" required />
              </div>
            </div>
            <div>
              <label class="block text-sm mb-1">Address</label>
              <textarea id="regAddress" class="w-full border rounded-xl px-3 py-2" placeholder="Delivery address" rows="2" required></textarea>
            </div>
            <div>
              <label class="block text-sm mb-1">Password</label>
              <input type="password" id="regPassword" class="w-full border rounded-xl px-3 py-2" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" required />
            </div>
            <button class="btn btn-primary w-full" type="submit" id="btnRegister">
              Create Account
            </button>
            <p id="registerMsg" class="text-sm mt-2"></p>
          </form>
        </div>

        <!-- Login Card -->
        <div class="card p-6">
          <h2 class="text-xl font-semibold mb-1">Welcome back</h2>
          <p class="text-sm text-gray-600 mb-4">Login to manage your subscription.</p>
          <form id="loginForm" class="space-y-3">
            <div>
              <label class="block text-sm mb-1">Email</label>
              <input type="email" id="loginEmail" class="w-full border rounded-xl px-3 py-2" placeholder="you@example.com" required />
            </div>
            <div>
              <label class="block text-sm mb-1">Password</label>
              <input type="password" id="loginPassword" class="w-full border rounded-xl px-3 py-2" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" required />
            </div>
            <button class="btn btn-primary w-full" type="submit" id="btnLogin">
              Login
            </button>
            <p id="loginMsg" class="text-sm mt-2"></p>
          </form>
        </div>
      </div>
    </section>

    <!-- ===== USER DASHBOARD ===== -->
    <section id="dashboardSection" class="hidden fade-in">
      <div class="grid lg:grid-cols-3 gap-6">
        <!-- Sidebar -->
        <aside class="lg:col-span-1 space-y-6">
          <div class="card p-5">
            <h3 class="text-lg font-semibold mb-2">Profile</h3>
            <div id="profileBox" class="text-sm space-y-1">
              <div class="h-4 w-1/2 bg-gray-100 rounded"></div>
              <div class="h-4 w-1/3 bg-gray-100 rounded"></div>
            </div>
            <div class="mt-4">
              <span class="badge badge-indigo">Role: User</span>
            </div>
          </div>

          <div class="card p-5">
            <h3 class="text-lg font-semibold mb-2">Subscription Policy</h3>
            <ul class="text-sm list-disc pl-5 space-y-1">
              <li>Only <b>one active</b> subscription at a time.</li>
              <li>Admin assigns to an available farmer.</li>
              <li>Farmer updates status: <b>Approved â†’ Processed â†’ Delivered</b>.</li>
            </ul>
          </div>
        </aside>

        <!-- Main -->
        <main class="lg:col-span-2 space-y-6">
          <!-- Create Subscription -->
          <div class="card p-5">
            <div class="flex items-center justify-between gap-2 mb-2">
              <h3 class="text-lg font-semibold">Create Subscription</h3>
              <span id="activeGuard" class="badge badge-gray hidden">Active subscription exists</span>
            </div>
            <form id="subscriptionForm" class="grid md:grid-cols-4 gap-3">
              <div>
                <label class="block text-sm mb-1">Plan</label>
                <select id="planType" class="w-full border rounded-xl px-3 py-2" required>
                  <option value="weekly">Weekly</option>
                  <option value="monthly">Monthly</option>
                </select>
              </div>
              <div>
                <label class="block text-sm mb-1">Quantity (L/day)</label>
                <input type="number" id="quantity" min="0.5" step="0.5" class="w-full border rounded-xl px-3 py-2" placeholder="e.g., 1" required/>
              </div>
              <div>
                <label class="block text-sm mb-1">Start Date</label>
                <input type="date" id="startDate" class="w-full border rounded-xl px-3 py-2" required/>
              </div>
              <div class="flex items-end">
                <button class="btn btn-primary w-full" type="submit" id="btnCreateSub">Create</button>
              </div>
            </form>
            <p id="subMsg" class="text-sm mt-2"></p>
          </div>

          <!-- Current Subscription -->
          <div class="card p-5">
            <div class="flex items-center justify-between mb-2">
              <h3 class="text-lg font-semibold">Current Subscription</h3>
              <span id="currentStatusBadge" class="badge badge-gray">No Active Subscription</span>
            </div>

            <div id="currentSubBox" class="text-sm text-gray-700">
              <p class="text-gray-500">No active subscription found.</p>
            </div>

            <!-- Timeline -->
            <div id="timelineBox" class="mt-5 hidden">
              <h4 class="font-semibold mb-2">Delivery Status Timeline</h4>
              <div class="grid grid-cols-5 gap-2 text-center">
                <div class="p-2 rounded-lg border" id="tlPending">Pending</div>
                <div class="p-2 rounded-lg border" id="tlAssigned">Assigned</div>
                <div class="p-2 rounded-lg border" id="tlApproved">Approved</div>
                <div class="p-2 rounded-lg border" id="tlProcessed">Processed</div>
                <div class="p-2 rounded-lg border" id="tlDelivered">Delivered</div>
              </div>
              <p class="text-xs text-gray-500 mt-2">This updates automatically when Admin/Farmer take action.</p>
            </div>
          </div>

          <!-- History -->
          <div class="card p-5">
            <div class="flex items-center justify-between">
              <h3 class="text-lg font-semibold">Subscription History</h3>
            </div>
            <div id="historyBox" class="mt-3 text-sm">
              <p class="text-gray-500">No past subscriptions yet.</p>
            </div>
          </div>
        </main>
      </div>
    </section>
  </div>

  <!-- Firebase (ES Modules) -->
  <script type="module">
    // =======================
    // 1) Firebase Init (INLINE)
    // =======================
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getAuth, onAuthStateChanged, createUserWithEmailAndPassword,
      signInWithEmailAndPassword, signOut, updateProfile
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import {
      getFirestore, doc, getDoc, setDoc, serverTimestamp,
      collection, addDoc, query, where, orderBy, onSnapshot, getDocs, updateDoc
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // TODO: Replace with your Firebase project config
   const firebaseConfig = {
  apiKey: "AIzaSyCayl1Hkzf7krOjqlxqWEbBpNZC8m41BBk",
  authDomain: "milqly.firebaseapp.com",
  projectId: "milqly",
  storageBucket: "milqly.firebasestorage.app",
  messagingSenderId: "509357207390",
  appId: "1:509357207390:web:47a4c7bc0af3373cd0a9cf",
  measurementId: "G-Z576VSVC5J"
};

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // =======================
    // 2) UI Helpers
    // =======================
    const $ = (id) => document.getElementById(id);
    const authSection = $("authSection");
    const dashboardSection = $("dashboardSection");
    const btnGoAuth = $("btnGoAuth");
    const btnGoDashboard = $("btnGoDashboard");
    const btnLogout = $("btnLogout");

    const registerForm = $("registerForm");
    const loginForm = $("loginForm");
    const registerMsg = $("registerMsg");
    const loginMsg = $("loginMsg");

    const profileBox = $("profileBox");
    const subscriptionForm = $("subscriptionForm");
    const subMsg = $("subMsg");
    const activeGuard = $("activeGuard");

    const currentStatusBadge = $("currentStatusBadge");
    const currentSubBox = $("currentSubBox");
    const historyBox = $("historyBox");

    const timelineBox = $("timelineBox");
    const tlPending = $("tlPending");
    const tlAssigned = $("tlAssigned");
    const tlApproved = $("tlApproved");
    const tlProcessed = $("tlProcessed");
    const tlDelivered = $("tlDelivered");

    const state = {
      user: null,
      activeSubUnsub: null,
      historyUnsub: null
    };

    function showAuth() {
      authSection.classList.remove("hidden");
      dashboardSection.classList.add("hidden");
      btnGoAuth.classList.add("hidden");
      btnGoDashboard.classList.add("hidden");
      btnLogout.classList.add("hidden");
    }
    function showDashboard() {
      authSection.classList.add("hidden");
      dashboardSection.classList.remove("hidden");
      btnGoAuth.classList.remove("hidden");
      btnGoDashboard.classList.add("hidden");
      btnLogout.classList.remove("hidden");
    }
    btnGoAuth.addEventListener("click", (e)=>{ e.preventDefault(); showAuth(); });
    $("btnGoDashboard").addEventListener("click", (e)=>{ e.preventDefault(); showDashboard(); });

    function setMsg(el, text, ok=false) {
      el.textContent = text || "";
      el.className = "text-sm mt-2 " + (ok ? "text-green-600" : "text-red-600");
    }

    function badgeColorForStatus(s) {
      switch(s){
        case "Pending": return "badge-yellow";
        case "Assigned": return "badge-blue";
        case "Approved": return "badge-indigo";
        case "Processed": return "badge-blue";
        case "Delivered": return "badge-green";
        default: return "badge-gray";
      }
    }

    function paintTimeline(status) {
      const clear = (el)=>{ el.className="p-2 rounded-lg border"; };
      [tlPending, tlAssigned, tlApproved, tlProcessed, tlDelivered].forEach(clear);
      function mark(el){ el.className="p-2 rounded-lg border bg-gray-900 text-white"; }
      // Order: Pending -> Assigned -> Approved -> Processed -> Delivered
      mark(tlPending);
      if (["Assigned","Approved","Processed","Delivered"].includes(status)) mark(tlAssigned);
      if (["Approved","Processed","Delivered"].includes(status)) mark(tlApproved);
      if (["Processed","Delivered"].includes(status)) mark(tlProcessed);
      if (["Delivered"].includes(status)) mark(tlDelivered);
    }

    // =======================
    // 3) Auth State
    // =======================
    onAuthStateChanged(auth, async (user)=>{
      state.user = user || null;

      if (!user) {
        // Cleanup listeners
        if (state.activeSubUnsub) { state.activeSubUnsub(); state.activeSubUnsub = null; }
        if (state.historyUnsub) { state.historyUnsub(); state.historyUnsub = null; }
        showAuth();
        return;
      }

      // Ensure user doc exists and has role=user
      const uref = doc(db, "users", user.uid);
      const snap = await getDoc(uref);
      if (!snap.exists()) {
        await setDoc(uref, {
          role: "user",
          name: user.displayName || "",
          phone: "",
          address: "",
          email: user.email,
          createdAt: serverTimestamp()
        });
      } else {
        const d = snap.data();
        if (d.role !== "user") {
          // If role is not 'user', we still allow login here, but display.
          // (In production, you'd redirect by role.)
        }
      }

      // Load profile
      loadProfile();

      // Subscribe to active subscription
      watchActiveSubscription();

      // Subscribe to history
      watchHistory();

      // Show dashboard
      showDashboard();
    });

    // =======================
    // 4) Register & Login
    // =======================
    registerForm.addEventListener("submit", async (e)=>{
      e.preventDefault();
      setMsg(registerMsg, "");
      const name = $("regName").value.trim();
      const phone = $("regPhone").value.trim();
      const email = $("regEmail").value.trim().toLowerCase();
      const address = $("regAddress").value.trim();
      const password = $("regPassword").value;

      if (!/^\d{10}$/.test(phone)) {
        return setMsg(registerMsg, "Please enter a valid 10-digit phone number.");
      }
      if (password.length < 6) {
        return setMsg(registerMsg, "Password should be at least 6 characters.");
      }

      try {
        const cred = await createUserWithEmailAndPassword(auth, email, password);
        if (name) await updateProfile(cred.user, { displayName: name });

        // Create/merge Firestore user doc with role=user
        const uref = doc(db, "users", cred.user.uid);
        await setDoc(uref, {
          role: "user",
          name,
          phone,
          address,
          email,
          createdAt: serverTimestamp()
        }, { merge: true });

        setMsg(registerMsg, "Account created! Redirecting to dashboardâ€¦", true);
      } catch (err) {
        setMsg(registerMsg, err.message || "Registration failed.");
      }
    });

    loginForm.addEventListener("submit", async (e)=>{
      e.preventDefault();
      setMsg(loginMsg, "");
      const email = $("loginEmail").value.trim().toLowerCase();
      const password = $("loginPassword").value;
      try {
        await signInWithEmailAndPassword(auth, email, password);
        setMsg(loginMsg, "Login successful! Redirectingâ€¦", true);
      } catch (err) {
        setMsg(loginMsg, err.message || "Login failed.");
      }
    });

    $("btnLogout").addEventListener("click", async ()=>{
      await signOut(auth);
    });

    // =======================
    // 5) Profile Loader
    // =======================
    async function loadProfile() {
      const uref = doc(db, "users", state.user.uid);
      const snap = await getDoc(uref);
      const d = snap.exists() ? snap.data() : {};
      profileBox.innerHTML = `
        <div><span class="text-gray-500">Name:</span> ${d.name || state.user.displayName || "-"}</div>
        <div><span class="text-gray-500">Email:</span> ${d.email || state.user.email || "-"}</div>
        <div><span class="text-gray-500">Phone:</span> ${d.phone || "-"}</div>
        <div><span class="text-gray-500">Address:</span> ${d.address || "-"}</div>
      `;
    }

    // =======================
    // 6) Create Subscription
    // =======================
    subscriptionForm.addEventListener("submit", async (e)=>{
      e.preventDefault();
      subMsg.textContent = "";

      // Guard: only one active at a time
      const hasActive = await userHasActiveSubscription(state.user.uid);
      if (hasActive) {
        activeGuard.classList.remove("hidden");
        return setMsg(subMsg, "You already have an active subscription.", false);
      }

      const planType = $("planType").value;
      const quantity = parseFloat($("quantity").value);
      const startDate = $("startDate").value;

      if (!(planType === "weekly" || planType === "monthly")) {
        return setMsg(subMsg, "Invalid plan selected.");
      }
      if (isNaN(quantity) || quantity <= 0) {
        return setMsg(subMsg, "Quantity must be greater than 0.");
      }
      if (!startDate) {
        return setMsg(subMsg, "Please choose a start date.");
      }

      try {
        await addDoc(collection(db, "subscriptions"), {
          userId: state.user.uid,
          planType,
          quantity,               // liters/day
          startDate,              // YYYY-MM-DD
          assignedFarmerId: null, // Admin will assign
          farmerApproval: "Pending", // Farmer side
          deliveryStatus: "Pending", // Pending -> Assigned -> Approved -> Processed -> Delivered
          isActive: true,
          createdAt: serverTimestamp()
        });
        setMsg(subMsg, "Subscription created! It will appear below and be sent to Admin for assignment.", true);
        subscriptionForm.reset();
      } catch (err) {
        setMsg(subMsg, err.message || "Failed to create subscription.");
      }
    });

    async function userHasActiveSubscription(uid){
      const q1 = query(
        collection(db, "subscriptions"),
        where("userId", "==", uid),
        where("isActive", "==", true)
      );
      const snap = await getDocs(q1);
      return !snap.empty;
    }

    // Live watcher for active sub (one at a time)
    function watchActiveSubscription(){
      if (state.activeSubUnsub) { state.activeSubUnsub(); state.activeSubUnsub = null; }
      const q1 = query(
        collection(db, "subscriptions"),
        where("userId", "==", state.user.uid),
        where("isActive", "==", true)
      );
      state.activeSubUnsub = onSnapshot(q1, (snap)=>{
        if (snap.empty) {
          // No active
          activeGuard.classList.add("hidden");
          currentStatusBadge.className = "badge badge-gray";
          currentStatusBadge.textContent = "No Active Subscription";
          currentSubBox.innerHTML = `<p class="text-gray-500">No active subscription found.</p>`;
          timelineBox.classList.add("hidden");
          // Enable form
          toggleSubForm(true);
          return;
        }

        // Active exists (we assume exactly one)
        const docData = snap.docs[0].data();
        const id = snap.docs[0].id;

        activeGuard.classList.remove("hidden");
        toggleSubForm(false);

        const st = docData.deliveryStatus || "Pending";
        currentStatusBadge.className = `badge ${badgeColorForStatus(st)}`;
        currentStatusBadge.textContent = st;

        const farmerText = docData.assignedFarmerId ? docData.assignedFarmerId : "Not assigned (Admin pending)";
        currentSubBox.innerHTML = `
          <div class="grid md:grid-cols-2 gap-2">
            <div><span class="text-gray-500">Plan:</span> ${docData.planType}</div>
            <div><span class="text-gray-500">Quantity:</span> ${docData.quantity} L/day</div>
            <div><span class="text-gray-500">Start Date:</span> ${docData.startDate}</div>
            <div><span class="text-gray-500">Farmer:</span> ${farmerText}</div>
          </div>
          <div class="mt-3">
            <button class="btn btn-outline" id="btnRefresh">Refresh</button>
            ${st === "Delivered" ? `<button class="btn btn-primary ml-2" id="btnMarkComplete">Mark as Completed</button>` : ""}
          </div>
        `;

        // Timeline
        timelineBox.classList.remove("hidden");
        paintTimeline(st);

        // Hook buttons
        const refreshBtn = $("btnRefresh");
        if (refreshBtn) refreshBtn.onclick = ()=>watchActiveSubscription();
        const btnMarkComplete = $("btnMarkComplete");
        if (btnMarkComplete) {
          btnMarkComplete.onclick = async ()=>{
            try {
              await updateDoc(doc(db, "subscriptions", id), { isActive: false });
            } catch (e) {
              alert(e.message || "Failed to complete.");
            }
          };
        }
      });
    }

    function toggleSubForm(enable){
      ["planType","quantity","startDate","btnCreateSub"].forEach(id=>{
        const el = $(id);
        el.disabled = !enable;
        if (!enable) {
          el.classList.add("opacity-60","cursor-not-allowed");
        } else {
          el.classList.remove("opacity-60","cursor-not-allowed");
        }
      });
    }

    // History (inactive or delivered)
    function watchHistory(){
      if (state.historyUnsub) { state.historyUnsub(); state.historyUnsub = null; }
      const qh = query(
        collection(db, "subscriptions"),
        where("userId", "==", state.user.uid),
        orderBy("createdAt", "desc")
      );
      state.historyUnsub = onSnapshot(qh, (snap)=>{
        if (snap.empty) {
          historyBox.innerHTML = `<p class="text-gray-500">No past subscriptions yet.</p>`;
          return;
        }
        const rows = [];
        snap.forEach(d=>{
          const s = d.data();
          // Show all, highlight active
          rows.push(`
            <tr class="hover:bg-gray-50">
              <td class="px-3 py-2">${s.planType}</td>
              <td class="px-3 py-2">${s.quantity} L/day</td>
              <td class="px-3 py-2">${s.startDate || "-"}</td>
              <td class="px-3 py-2">
                <span class="badge ${badgeColorForStatus(s.deliveryStatus || "Pending")}">
                  ${s.deliveryStatus || "Pending"}
                </span>
              </td>
              <td class="px-3 py-2">${s.isActive ? '<span class="badge badge-blue">Active</span>' : '<span class="badge badge-gray">Inactive</span>'}</td>
            </tr>
          `);
        });
        historyBox.innerHTML = `
          <div class="overflow-auto rounded-xl border">
            <table class="min-w-full text-sm">
              <thead class="bg-gray-100 text-left">
                <tr>
                  <th class="px-3 py-2">Plan</th>
                  <th class="px-3 py-2">Qty</th>
                  <th class="px-3 py-2">Start</th>
                  <th class="px-3 py-2">Delivery Status</th>
                  <th class="px-3 py-2">Active</th>
                </tr>
              </thead>
              <tbody>${rows.join("")}</tbody>
            </table>
          </div>
        `;
      });
    }

    // =======================
    // 7) Small niceties
    // =======================
    // Prefill date with tomorrow
    const startDateInput = $("startDate");
    if (startDateInput) {
      const t = new Date();
      t.setDate(t.getDate()+1);
      const yyyy = t.getFullYear();
      const mm = String(t.getMonth()+1).padStart(2,"0");
      const dd = String(t.getDate()).padStart(2,"0");
      startDateInput.value = `${yyyy}-${mm}-${dd}`;
      startDateInput.min = `${yyyy}-${mm}-${dd}`;
    }
  </script>
</body>
</html>
