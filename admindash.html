<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Admin Dashboard</title>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      background: linear-gradient(to right, #f8f9fa, #eef2f3);
    }
    header {
      background: linear-gradient(to right, #4e54c8, #8f94fb);
      color: white;
      padding: 15px;
      text-align: center;
      font-size: 22px;
      font-weight: bold;
    }
    .container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      padding: 20px;
    }
    .card {
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 6px 12px rgba(0,0,0,0.1);
    }
    .card h3 {
      margin-top: 0;
      margin-bottom: 10px;
    }
    .blue { border-top: 6px solid #4e54c8; }
    .green { border-top: 6px solid #28a745; }
    .orange { border-top: 6px solid #fd7e14; }
    button {
      background: #4e54c8;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 6px;
      cursor: pointer;
      margin-top: 5px;
    }
    button:hover {
      background: #3b42a1;
    }
    select {
      padding: 5px;
      margin-left: 8px;
    }
  </style>
</head>
<body>
  <header>Admin Dashboard</header>
  <div class="container">
    <div class="card blue">
      <h3>Pending Farmer Applications</h3>
      <ul id="pendingFarmers"></ul>
    </div>

    <div class="card green">
      <h3>User Subscriptions (Unassigned)</h3>
      <ul id="unassignedSubs"></ul>
    </div>

    <div class="card orange" style="grid-column: span 2;">
      <h3>Assigned Deliveries</h3>
      <ul id="assignedDeliveries"></ul>
    </div>
  </div>

  <script>
    // ✅ Your Firebase Config here
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT.firebaseapp.com",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_PROJECT.appspot.com",
      messagingSenderId: "SENDER_ID",
      appId: "APP_ID"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // Load Pending Farmers
    function loadPendingFarmers() {
      db.collection("farmers").where("status", "==", "pending")
        .onSnapshot(snapshot => {
          let list = document.getElementById("pendingFarmers");
          list.innerHTML = "";
          snapshot.forEach(doc => {
            let farmer = doc.data();
            let li = document.createElement("li");
            li.innerHTML = `
              ${farmer.name} (${farmer.email})
              <button onclick="approveFarmer('${doc.id}')">Approve</button>
            `;
            list.appendChild(li);
          });
        });
    }

    function approveFarmer(farmerId) {
      db.collection("farmers").doc(farmerId).update({ status: "approved" });
    }

    // Load Unassigned User Subscriptions
    function loadUnassignedSubs() {
      db.collection("subscriptions").where("assignedTo", "==", null)
        .onSnapshot(async snapshot => {
          let list = document.getElementById("unassignedSubs");
          list.innerHTML = "";

          // Fetch approved farmers for dropdown
          let farmersSnap = await db.collection("farmers").where("status", "==", "approved").get();
          let farmerOptions = "";
          farmersSnap.forEach(f => {
            farmerOptions += `<option value="${f.id}">${f.data().name}</option>`;
          });

          snapshot.forEach(doc => {
            let sub = doc.data();
            let li = document.createElement("li");
            li.innerHTML = `
              ${sub.userEmail} → ${sub.plan}
              <select id="farmerSelect-${doc.id}">
                <option value="">Assign Farmer</option>
                ${farmerOptions}
              </select>
              <button onclick="assignFarmer('${doc.id}')">Assign</button>
            `;
            list.appendChild(li);
          });
        });
    }

    function assignFarmer(subId) {
      let select = document.getElementById(`farmerSelect-${subId}`);
      let farmerId = select.value;
      if (farmerId) {
        db.collection("subscriptions").doc(subId).update({ assignedTo: farmerId, status: "assigned" });
      }
    }

    // Load Assigned Deliveries
    function loadAssignedDeliveries() {
      db.collection("subscriptions").where("status", "==", "assigned")
        .onSnapshot(snapshot => {
          let list = document.getElementById("assignedDeliveries");
          list.innerHTML = "";
          snapshot.forEach(doc => {
            let sub = doc.data();
            let li = document.createElement("li");
            li.textContent = `${sub.userEmail} → ${sub.plan} (Assigned to Farmer: ${sub.assignedTo})`;
            list.appendChild(li);
          });
        });
    }

    // Run loaders
    loadPendingFarmers();
    loadUnassignedSubs();
    loadAssignedDeliveries();
  </script>
</body>
</html>
